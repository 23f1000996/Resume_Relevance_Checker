<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Resume Relevance Checker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
            <h1 class="text-4xl font-extrabold text-center text-gray-800 tracking-tight leading-none mb-2">Automated Resume Relevance Check</h1>
            <p class="text-center text-gray-500 text-lg">Automate resume evaluation against job requirements with an AI-powered system.</p>
        </header>

        <!-- Main Form & Results -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Upload & Analyze Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Input & Analysis</h2>

                <!-- Job Description Upload -->
                <div class="space-y-2">
                    <label for="jdFileInput" class="block text-sm font-medium text-gray-700">Upload Job Description (.txt)</label>
                    <input type="file" id="jdFileInput" accept=".txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer">
                    <div id="jdTextDisplay" class="mt-2 text-xs text-gray-500 bg-gray-50 p-3 rounded-md min-h-[50px] max-h-[150px] overflow-auto border border-gray-200">No file selected.</div>
                </div>

                <!-- Resume Upload -->
                <div class="space-y-2">
                    <label for="resumeFileInput" class="block text-sm font-medium text-gray-700">Upload Resume (.txt)</label>
                    <input type="file" id="resumeFileInput" accept=".txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer">
                    <div id="resumeTextDisplay" class="mt-2 text-xs text-gray-500 bg-gray-50 p-3 rounded-md min-h-[50px] max-h-[150px] overflow-auto border border-gray-200">No file selected.</div>
                </div>
                
                <!-- Hard Skills Input -->
                <div class="space-y-2">
                    <label for="hardSkillsInput" class="block text-sm font-medium text-gray-700">Must-have Skills (for Hard Match)</label>
                    <input type="text" id="hardSkillsInput" placeholder="e.g., Python, SQL, Machine Learning" class="w-full rounded-full border-gray-300 shadow-sm p-3 text-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    <p class="text-xs text-gray-400">Separate skills with commas.</p>
                </div>

                <!-- Analyze Button -->
                <button id="analyzeButton" class="w-full flex items-center justify-center bg-violet-600 text-white rounded-full p-4 font-semibold text-lg hover:bg-violet-700 transition duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2">
                    <svg id="loadingIndicator" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyze Resume
                </button>
            </div>

            <!-- Output Section -->
            <div id="resultsContainer" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Evaluation Results</h2>

                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-500">Relevance Score</p>
                        <p id="scoreText" class="text-5xl font-extrabold text-gray-900 mt-1">-- / 100</p>
                    </div>
                    <div class="flex-1 text-center">
                        <p class="text-sm font-medium text-gray-500">Verdict</p>
                        <p id="verdictText" class="text-3xl font-extrabold text-gray-900 mt-1">--</p>
                    </div>
                </div>

                <!-- Missing Skills Section -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-2">Missing Key Elements</h3>
                    <ul id="missingSkillsList" class="list-disc list-inside space-y-1">
                        <li class="text-sm text-gray-700">Please run an analysis to see results.</li>
                    </ul>
                </div>

                <!-- Student Feedback Section -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-2">Suggestions for Improvement</h3>
                    <p id="studentFeedbackText" class="text-sm text-gray-700 italic">This section will provide actionable feedback for the student after the analysis is complete.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Placement Team Dashboard</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Description</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resume</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verdict</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Missing Skills</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suggestions</th>
                        </tr>
                    </thead>
                    <tbody id="evaluationsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="py-4 text-center text-gray-500">Waiting for first evaluation...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <!-- Custom Modal -->
    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96 mx-auto">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Notification</h3>
            <p id="modalMessage" class="text-sm text-gray-500 mb-4"></p>
            <div class="text-right">
                <button id="closeModalButton" class="inline-flex justify-center rounded-md border border-transparent bg-violet-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-700 focus:outline-none">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // UI elements
        const jdFileInput = document.getElementById('jdFileInput');
        const resumeFileInput = document.getElementById('resumeFileInput');
        const jdTextDisplay = document.getElementById('jdTextDisplay');
        const resumeTextDisplay = document.getElementById('resumeTextDisplay');
        const hardSkillsInput = document.getElementById('hardSkillsInput');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const evaluationsTableBody = document.getElementById('evaluationsTableBody');
        const missingSkillsList = document.getElementById('missingSkillsList');
        const verdictText = document.getElementById('verdictText');
        const scoreText = document.getElementById('scoreText');
        const studentFeedbackText = document.getElementById('studentFeedbackText');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // State variables to hold file content
        let jdText = '';
        let resumeText = '';

        // Function to show a custom modal instead of alert()
        const showModal = (message) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        };

        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Function to handle file reading
        const readFile = (file, displayElement) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    displayElement.textContent = 'No file selected.';
                    resolve('');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    displayElement.textContent = text.substring(0, 500) + '...';
                    resolve(text);
                };
                reader.onerror = (e) => {
                    displayElement.textContent = 'Error reading file.';
                    reject(e);
                };
                reader.readAsText(file);
            });
        };

        // Event listener for analysis button
        analyzeButton.addEventListener('click', async () => {
            if (!jdText || !resumeText) {
                showModal('Please upload both Job Description and Resume files.');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            analyzeButton.disabled = true;

            const hardSkills = hardSkillsInput.value.split(',').map(s => s.trim()).filter(s => s);

            try {
                const response = await fetch(window.location.origin + '/analyze_resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jdText: jdText,
                        resumeText: resumeText,
                        hardSkills: hardSkills
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showModal(error.error || 'An error occurred during analysis.');
                    return;
                }

                const result = await response.json();
                
                scoreText.textContent = `${result.score} / 100`;
                verdictText.textContent = result.verdict;
                const verdictColorClass = result.verdict.includes('High') ? 'text-green-600' : result.verdict.includes('Medium') ? 'text-yellow-600' : 'text-red-600';
                verdictText.className = `text-3xl font-extrabold mt-1 ${verdictColorClass}`;
                missingSkillsList.innerHTML = result.missingSkills.length > 0
                    ? result.missingSkills.map(skill => `<li class="text-sm text-gray-700">${skill}</li>`).join('')
                    : '<li class="text-sm text-gray-700">All key skills found!</li>';
                studentFeedbackText.textContent = result.suggestions;

                // Refresh the dashboard after a successful analysis
                fetchEvaluations();

            } catch (error) {
                console.error("Error analyzing resume:", error);
                showModal("Failed to connect to the analysis service. Please try again.");
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        });

        // Event listeners for file inputs
        jdFileInput.addEventListener('change', async (e) => {
            jdText = await readFile(e.target.files[0], jdTextDisplay);
        });

        resumeFileInput.addEventListener('change', async (e) => {
            resumeText = await readFile(e.target.files[0], resumeTextDisplay);
        });

        // Function to fetch evaluations for the dashboard
        const fetchEvaluations = async () => {
            try {
                const response = await fetch(window.location.origin + '/evaluations');
                if (!response.ok) {
                    console.error("Failed to fetch evaluations.");
                    return;
                }
                const evaluations = await response.json();
                
                let evaluationsHtml = '';
                if (evaluations.length === 0) {
                    evaluationsHtml = `<tr><td colspan="6" class="py-4 text-center text-gray-500">No evaluations found.</td></tr>`;
                } else {
                    evaluations.forEach((data) => {
                        const verdictColorClass = data.verdict.includes('High') ? 'text-green-600' : data.verdict.includes('Medium') ? 'text-yellow-600' : 'text-red-600';
                        evaluationsHtml += `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">${data.jd_text.substring(0, 50)}...</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">${data.resume_text.substring(0, 50)}...</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-bold text-gray-900">${data.score}</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-medium ${verdictColorClass}">${data.verdict}</td>
                                <td class="py-2 px-4 text-sm text-gray-700">${data.missing_skills.join(', ') || 'None'}</td>
                                <td class="py-2 px-4 text-sm text-gray-700 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${data.suggestions}</td>
                            </tr>
                        `;
                    });
                }
                evaluationsTableBody.innerHTML = evaluationsHtml;
            } catch (error) {
                console.error("Error fetching dashboard data:", error);
            }
        };

        // Initial fetch of evaluations when the page loads
        document.addEventListener('DOMContentLoaded', fetchEvaluations);

        // Periodically refresh the dashboard
        setInterval(fetchEvaluations, 10000); // Refresh every 10 seconds

    </script>
</body>
</html>
